---
layout: post
title: "WebM and ffmpeg: concatenate videos and add bumpers"
permalink: e/funwithwebm
---


<h1>WebM and ffmpeg: concatenate videos and add bumpers</h1>

<p>So I have this MP4 video. I want to:</p>

<ul>
  <li>transcode it to WebM;
  <li>create a bumper: a little video to introduce the main video. Just a text;
  <li>concatenate my bumper with the WebM main video.

</ul>

<p>The original video is named <em>girltalk.mp4</em>.</p>

<h2>Transcode to WebM with ffmpeg</h2>
<p>Easy:</p>
<pre>
$ ffmpeg -i girltalk.mp4 \
  -f webm -vcodec libvpx \
  -acodec libvorbis \
  -aq 90 -ac 2 \
  girltalk.webm
</pre>
<p>(You need a version of ffmpeg >= 0.6)</p>

<p>Interesting extra options:</p>
<pre>
If you want no audio:
-an : Disable audio

If you want just a subsection of the video
-ss <timecode> : Set start time offset in seconds or hh:mm:ss[.xxx] format.
-t <timecode> : Set recording time in seconds or hh:mm:ss[.xxx] format.

if you want to resize the video
-s <string> : Set frame size ( WidthxHeight)

if you want to crop the video
-cropbottom <int> : Set bottom crop band size ( in pixels ).
-cropleft <int> : Set left crop band size ( in pixels ).
-cropright <int> : Set right crop band size ( in pixels ).
-croptop <int> : Set top crop band size ( in pixels ).

</pre>

<h2>Create the bumper</h2>

<h3>Create one image</h3>

First, you need the dimension of the video:
<pre>
$ ffmpeg -i girltalk.webm 2>&1 | grep "Stream \#0.0"


  Stream #0.0: Video: libvpx, yuv420p, 320x240,\
    PAR 1:1 DAR 4:3, 12 fps, \
    12 tbr, 1k tbn, 12 tbc
</pre>
Got it: 320x240.

<p>Create the bumper with your prefered image editor (Gimp!). So far, it's just an image of the same size as the video.</p>
<p>Here's mine:</p>

<img src="http://people.mozilla.com/~prouget/blog/funwithwebm/bumper.png">

<h3>Create a video from the image</h3>
<p>You need the framerate of your main video. From the previous command, we know it's <strong>12 fps</strong> (the quality of this video is really poor, usually, it's 25). Also, you'll need to know the audio sampling frequency.</p>

<pre>
$ ffmpeg -i girltalk.webm 2>&1 | grep "Stream \#0.1"



  Stream #0.0: Video: libvpx, yuv420p, 320x240,\
    PAR 1:1 DAR 4:3, 12 fps, \
    12 tbr, 1k tbn, 12 tbc
</pre>

<p>22050 Hz here. Usually it's 44100 Hz.</p>

<p>You also need to know how you long you want your bumper to last. Let's say 5 seconds:</p>

<pre>
ffmpeg \
  -loop_input -f image2 -i bumper.jpg\
  -acodec pcm_s16le -f s16le -i /dev/zero \
  -r 12 -t 5 \
  -map 0:0 -map 1:0 \
  -f webm -vcodec libvpx \
  -ar 22050 -acodec libvorbis -aq 90 -ac 2 \
  bumper.webm
</pre>

So here, I create a video which is just this bumper image repeated 12 times per second during 5 seconds, with a <em>silence</em> track (important).

Result:

<video src="http://people.mozilla.com/~prouget/blog/funwithwebm/bumper.webm" controls></video>

<h2>Concatenate WebM videos</h2>
<p>Ok, so now, we have 2 videos. And we want to concatenate them.</p>

<p>WebM is an interesting format. You can just put the 2 videos inside the same file, no need to reencode.
The only condition is to have the same bitrate and the same number of tracks.
That's why we create a "silence" track and we respected the main video bitrate for the bumper video.</p>

<p>So to "repackage" the video with two videos inside (hmmm), you'll need <em>mkvmerge</em>, from <em>mkvtoolnix</em>:</p>
<pre>
$ mkvmerge -o girltalk.final.webm bumper.webm +girltalk.webm
</pre>

<p><strong>If you have any problems with the last command, just check the 2 streams from the 2 videos (ffmpeg -i video.webm),
they have to have the exact same properties.</strong></p>

<p>Enjoy the result:</p>

<video src="http://people.mozilla.com/~prouget/blog/funwithwebm/girltalk.final.webm" controls></video>

<p><strong>Note: sounds like Chrome WebM decoder doesn't take into account the chained tracks in WebM. Works well in Firefox and Opera.</strong></p>

